<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INDEX & MATCH Practice Trainer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1e40af',
                        'secondary-yellow': '#fde047',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better readability and structure */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Style for the header row with column letters (A, B, C...) */
        #data-table thead tr:first-child th {
            background-color: #9ca3af; /* Gray-400 */
            color: #1f2937; /* Gray-800 */
            font-weight: 900;
            border-right: 1px solid #f3f4f6;
            padding-top: 4px;
            padding-bottom: 4px;
        }
        /* Style for the header row with data names */
        #data-table thead tr:last-child th {
            background-color: #bfdbfe; /* Blue-200 */
            color: #1e40af; /* primary-blue */
            border-right: 1px solid #d1d5db;
        }
        /* Style for the Row Number column in the body */
        #data-table tbody td:first-child {
            background-color: #e5e7eb; /* Gray-200 */
            font-weight: 700;
            text-align: center;
            border-right: 1px solid #f3f4f6;
        }
        .feedback { transition: all 0.3s ease-in-out; }
        
        .check-button-active {
            background-color: #1e40af;
            cursor: pointer;
        }
        .check-button-inactive {
            background-color: #a8a29e; /* Stone-400 */
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <!-- Title and Instructions -->
        <h1 class="text-3xl font-extrabold text-primary-blue mb-2 tracking-tight">
            Excel INDEX & MATCH Trainer
        </h1>
        <p class="text-gray-600 mb-6 border-b pb-4" id="mode-instructions">
            Enter the full Excel formula to find the correct value based on the dataset below. 
        </p>

        <!-- Current Task Section -->
        <div id="task-section" class="mb-8 p-4 bg-secondary-yellow/30 border-l-4 border-secondary-yellow rounded-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-1">Context: <span id="context-display" class="font-normal text-primary-blue"></span></h2>
            <p class="text-2xl font-semibold text-gray-900" id="question-display">
                
            </p>
        </div>

        <!-- Data Table Display -->
        <h3 class="text-xl font-semibold text-gray-700 mb-3 mt-8">Current Dataset:</h3>
        <div class="overflow-x-auto mb-8 shadow-lg rounded-lg">
            <!-- Table content is now fully generated by JavaScript to include A1 notation structure -->
            <table id="data-table" class="data-table min-w-full divide-y divide-gray-200 rounded-lg"></table>
        </div>

        <!-- Input Section -->
        <div class="space-y-4" id="input-container">
            <label for="formula-input" id="formula-label" class="block text-lg font-medium text-gray-700">Your Formula:</label>
            <input type="text" id="formula-input" 
                   placeholder='e.g., =INDEX(D2:D7; MATCH("John Smith"; B2:B7; 0)) or =INDEX(D2:D7, MATCH("John Smith", B2:B7, 0))'
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue text-lg font-mono">
            
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="check-button" onclick="checkAnswer()"
                        class="w-full sm:w-1/3 px-6 py-3 text-lg font-semibold text-white rounded-lg transition shadow-md check-button-active hover:bg-blue-800">
                    Check Answer
                </button>
                <button id="next-button" onclick="nextTask()" disabled
                        class="w-full sm:w-1/3 px-6 py-3 text-lg font-semibold text-white bg-gray-400 rounded-lg transition shadow-md opacity-50 cursor-not-allowed">
                    Next Task &rarr;
                </button>
                <button id="challenge-button" onclick="startChallengeMode()"
                        class="w-full sm:w-1/3 px-6 py-3 text-lg font-semibold text-white bg-red-600 rounded-lg transition shadow-md hover:bg-red-700">
                    Start 5-Question Challenge
                </button>
            </div>
        </div>

        <!-- Feedback Section -->
        <div id="feedback-message" class="feedback mt-6 p-4 rounded-lg text-center font-bold text-xl min-h-[4rem]">
            <!-- Feedback will appear here -->
        </div>

    </div>

    <script>
        // --- DATA DEFINITION ---

        const DATA_SETS = {
            employee: {
                headers: ["Employee ID", "Name", "Department", "Salary ($)"],
                data: [
                    ["E505", "John Smith", "Sales", 65000],
                    ["E812", "Jane Doe", "Marketing", 75000],
                    ["E910", "Bob Johnson", "IT", 92000],
                    ["E345", "Alice Brown", "HR", 58000],
                    ["E601", "Mark Williams", "Sales", 68000],
                    ["E215", "Emily Davis", "Marketing", 72000],
                ]
            },
            inventory: {
                headers: ["SKU", "Item Name", "Warehouse Location", "Quantity in Stock"],
                data: [
                    ["87B-03", "Safety Goggles", "A-45", 1200],
                    ["44C-11", "Box of Screws", "B-12", 800],
                    ["91D-20", "Power Drill", "C-01", 350],
                    ["12A-55", "Extension Cord", "A-45", 1550],
                    ["66F-08", "Steel Cable", "C-05", 2100],
                    ["33G-15", "Work Gloves", "B-07", 1100],
                ]
            },
            grades: {
                headers: ["Student ID", "Student Name", "Assignment 1 Score", "Final Grade"],
                data: [
                    ["S1002", "Emily Brown", 88, "B"],
                    ["S1001", "David Lee", 95, "A"],
                    ["S1004", "Michael Clark", 79, "C"],
                    ["S1005", "Sarah Green", 98, "A"],
                    ["S1003", "Daniel King", 65, "D"],
                    ["S1006", "Jessica White", 82, "B"],
                ]
            },
            sales: {
                headers: ["Rep ID", "Sales Region", "Product Sold", "Sales Volume ($)"],
                data: [
                    ["R201", "North", "Widget X", 120000],
                    ["R550", "South", "Service Y", 45000],
                    ["R311", "East", "Widget X", 155000],
                    ["R602", "West", "Service Y", 88000],
                    ["R105", "North", "Widget Z", 95000],
                    ["R444", "South", "Widget X", 70000],
                ]
            },
            menu: {
                headers: ["Item ID", "Item Name", "Category", "Price ($)"],
                data: [
                    ["D301", "Chocolate Cake", "Dessert", 8.50],
                    ["M101", "Grilled Salmon", "Main Course", 24.00],
                    ["A405", "Caesar Salad", "Appetizer", 10.99],
                    ["M105", "Filet Mignon", "Main Course", 32.50],
                    ["D305", "Ice Cream Sundae", "Dessert", 6.50],
                    ["A401", "Garlic Bread", "Appetizer", 5.99],
                ]
            }
        };

        const ALL_TASKS = [
            // Context 1: Employee Data (HR/Payroll)
            { id: 1, context: 'Employee Data', dataSet: 'employee', question: 'What is the Salary for E505?', lookupValue: 'E505', lookupHeader: 'Employee ID', returnHeader: 'Salary ($)', answer: 65000 },
            { id: 2, context: 'Employee Data', dataSet: 'employee', question: 'Find the ID of the employee who has the lowest Salary.', lookupValue: 'MIN', lookupHeader: 'Salary ($)', returnHeader: 'Employee ID', answer: 'E345' },
            { id: 3, context: 'Employee Data', dataSet: 'employee', question: 'What Department is Jane Doe in?', lookupValue: 'Jane Doe', lookupHeader: 'Name', returnHeader: 'Department', answer: 'Marketing' },

            // Context 2: Inventory Management (Warehouse/Logistics)
            { id: 4, context: 'Inventory Management', dataSet: 'inventory', question: 'What is the Quantity in Stock for SKU 87B-03?', lookupValue: '87B-03', lookupHeader: 'SKU', returnHeader: 'Quantity in Stock', answer: 1200 },
            { id: 5, context: 'Inventory Management', dataSet: 'inventory', question: 'Which Item Name is located in Location B-07?', lookupValue: 'B-07', lookupHeader: 'Warehouse Location', returnHeader: 'Item Name', answer: 'Work Gloves' },
            { id: 6, context: 'Inventory Management', dataSet: 'inventory', question: 'Which SKU has the largest Quantity in Stock?', lookupValue: 'MAX', lookupHeader: 'Quantity in Stock', returnHeader: 'SKU', answer: '66F-08' },
            
            // Context 3: Student Grades (Education)
            { id: 7, context: 'Student Grades', dataSet: 'grades', question: 'Find the Final Grade for Student ID S1002.', lookupValue: 'S1002', lookupHeader: 'Student ID', returnHeader: 'Final Grade', answer: 'B' },
            { id: 8, context: 'Student Grades', dataSet: 'grades', question: 'What is the Assignment 1 Score for Sarah Green?', lookupValue: 'Sarah Green', lookupHeader: 'Student Name', returnHeader: 'Assignment 1 Score', answer: 98 },
            { id: 9, context: 'Student Grades', dataSet: 'grades', question: 'Which Student ID has the highest Assignment 1 Score?', lookupValue: 'MAX', lookupHeader: 'Assignment 1 Score', returnHeader: 'Student ID', answer: 'S1005' },

            // Context 4: Sales Data (Finance/Marketing)
            { id: 10, context: 'Sales Data', dataSet: 'sales', question: 'What is the Sales Volume for Rep ID R602?', lookupValue: 'R602', lookupHeader: 'Rep ID', returnHeader: 'Sales Volume ($)', answer: 88000 },
            { id: 11, context: 'Sales Data', dataSet: 'sales', question: 'Find the Product Sold by Rep ID R311.', lookupValue: 'R311', lookupHeader: 'Rep ID', returnHeader: 'Product Sold', answer: 'Widget X' },
            { id: 12, context: 'Sales Data', dataSet: 'sales', question: 'Which Rep ID achieved the highest Sales Volume?', lookupValue: 'MAX', lookupHeader: 'Sales Volume ($)', returnHeader: 'Rep ID', answer: 'R311' },

            // Context 5: Restaurant Menu (Hospitality)
            { id: 13, context: 'Restaurant Menu', dataSet: 'menu', question: 'What is the Category for the item Caesar Salad?', lookupValue: 'Caesar Salad', lookupHeader: 'Item Name', returnHeader: 'Category', answer: 'Appetizer' },
            { id: 14, context: 'Restaurant Menu', dataSet: 'menu', question: 'Find the Price for Item ID D301.', lookupValue: 'D301', lookupHeader: 'Item ID', returnHeader: 'Price ($)', answer: 8.50 },
            { id: 15, context: 'Restaurant Menu', dataSet: 'menu', question: 'Which Item ID is the least expensive?', lookupValue: 'MIN', lookupHeader: 'Price ($)', returnHeader: 'Item ID', answer: 'A401' },
            
            { id: 16, context: 'Employee Data', dataSet: 'employee', question: 'Find the Name of the employee with the maximum Salary.', lookupValue: 'MAX', lookupHeader: 'Salary ($)', returnHeader: 'Name', answer: 'Bob Johnson' },
            { id: 17, context: 'Inventory Management', dataSet: 'inventory', question: 'What is the Item Name for SKU 33G-15?', lookupValue: '33G-15', lookupHeader: 'SKU', returnHeader: 'Item Name', answer: 'Work Gloves' },
            { id: 18, context: 'Grades', dataSet: 'grades', question: 'Find the Student ID of the student with Final Grade C.', lookupValue: 'C', lookupHeader: 'Final Grade', returnHeader: 'Student ID', answer: 'S1004' },
            { id: 19, context: 'Sales Data', dataSet: 'sales', question: 'What Sales Region is Rep ID R444 in?', lookupValue: 'R444', lookupHeader: 'Rep ID', returnHeader: 'Sales Region', answer: 'South' },
            { id: 20, context: 'Menu', dataSet: 'menu', question: 'What is the Item Name for Item ID M105?', lookupValue: 'M105', lookupHeader: 'Item ID', returnHeader: 'Item Name', answer: 'Filet Mignon' },
            { id: 21, context: 'Employee Data', dataSet: 'employee', question: 'What is the Department for Employee ID E601?', lookupValue: 'E601', lookupHeader: 'Employee ID', returnHeader: 'Department', answer: 'Sales' },
            { id: 22, context: 'Inventory Management', dataSet: 'inventory', question: 'What is the Quantity in Stock for Power Drill?', lookupValue: 'Power Drill', lookupHeader: 'Item Name', returnHeader: 'Quantity in Stock', answer: 350 },
            { id: 23, context: 'Grades', dataSet: 'grades', question: 'What is the Assignment 1 Score for Daniel King?', lookupValue: 'Daniel King', lookupHeader: 'Student Name', returnHeader: 'Assignment 1 Score', answer: 65 },
            { id: 24, context: 'Sales Data', dataSet: 'sales', question: 'Find the Rep ID who sold Widget Z.', lookupValue: 'Widget Z', lookupHeader: 'Product Sold', returnHeader: 'Rep ID', answer: 'R105' },
            { id: 25, context: 'Menu', dataSet: 'menu', question: 'What is the Price for Grilled Salmon?', lookupValue: 'Grilled Salmon', lookupHeader: 'Item Name', returnHeader: 'Price ($)', answer: 24.00 },
        ];


        // --- STATE MANAGEMENT ---
        let currentTaskIndex = 0;
        let tasks = []; // Will hold ALL_TASKS shuffled for normal mode

        let isChallengeMode = false;
        let challengeTasks = [];
        let challengeCurrentStep = 0;
        let challengeScore = 0;
        let challengeResults = []; // Stores results for review at end of challenge
        const CHALLENGE_LENGTH = 5;

        // --- UTILITY FUNCTIONS ---

        function getColumnIndex(headerName, headers) {
            return headers.indexOf(headerName);
        }
        
        function getColumnLetter(headerName, headers) {
            const index = headers.indexOf(headerName);
            if (index === -1) return null;
            return String.fromCharCode('A'.charCodeAt(0) + index);
        }

        function getExpectedRange(headerName, headers, dataLength) {
            const letter = getColumnLetter(headerName, headers);
            if (!letter) return null;
            return `${letter}2:${letter}${dataLength + 1}`;
        }

        function calculateExpectedAnswer(task, dataObj) {
            const data = dataObj.data;
            const headers = dataObj.headers;

            const lookupColIndex = getColumnIndex(task.lookupHeader, headers);
            const returnColIndex = getColumnIndex(task.returnHeader, headers);

            if (lookupColIndex === -1 || returnColIndex === -1) return null;

            let lookupValue = task.lookupValue;
            let targetRowIndex = -1;
            const lookupColumn = data.map(row => row[lookupColIndex]);

            if (lookupValue === 'MAX' || lookupValue === 'MIN') {
                const numericValues = lookupColumn.filter(v => typeof v === 'number');
                // Handle case where numericValues might be empty (though unlikely with defined datasets)
                if (numericValues.length === 0) return null; 
                lookupValue = lookupValue === 'MAX' ? Math.max(...numericValues) : Math.min(...numericValues);
            }

            for (let i = 0; i < data.length; i++) {
                if (data[i][lookupColIndex] === lookupValue) {
                    targetRowIndex = i;
                    break;
                }
            }

            if (targetRowIndex !== -1) {
                return data[targetRowIndex][returnColIndex];
            }

            return null;
        }

        function formatCellValue(value, header) {
            if (header.includes("($)") && typeof value === 'number') {
                return "$" + value.toLocaleString('en-US', { minimumFractionDigits: header.includes('Price') ? 2 : 0 });
            }
            return value;
        }

        /**
         * Core logic to validate a formula against the current task expectations.
         * @param {string} inputFormula The user's input.
         * @param {object} task The current task object.
         * @returns {{passed: boolean, errorMsg: string, expectedAnswer: any}} Validation result.
         */
        function validateFormula(inputFormula, task) {
            let cleanedInputFormula = inputFormula.startsWith('=') ? inputFormula.substring(1) : inputFormula;
            cleanedInputFormula = cleanedInputFormula.replace(/;/g, ','); 

            const dataset = DATA_SETS[task.dataSet];
            const dataLength = dataset.data.length; 
            const headers = dataset.headers;
            const expectedIndexRange = getExpectedRange(task.returnHeader, headers, dataLength);
            const expectedMatchRange = getExpectedRange(task.lookupHeader, headers, dataLength);
            const expectedAnswer = calculateExpectedAnswer(task, dataset);
            
            const cleanRange = (range) => range.toUpperCase().replace(/\s/g, '').replace(/\$/g, '');
            // Simplifies the content for comparison (removes quotes, spaces, currency symbols)
            const cleanValue = (value) => String(value).toUpperCase().replace(/[",\s]/g, '').replace(/\$/g, '');

            const indexMatchRegex = /INDEX\s*\(([^,]+)\s*,\s*MATCH\s*\(([^,]+)\s*,\s*([^,]+)\s*,\s*0\s*\)\s*\)/i;
            const match = cleanedInputFormula.match(indexMatchRegex);
            
            let passed = true;
            let errorMsg = "";

            if (!match) {
                passed = false;
                errorMsg = "The formula must follow the structure INDEX(return_range, MATCH(lookup_value, lookup_range, 0)). Please check your syntax and delimiters.";
                return { passed, errorMsg, expectedAnswer };
            }

            const extractedIndexRangeClean = cleanRange(match[1].trim());
            const extractedLookupValueRaw = match[2].trim();
            const extractedMatchRangeClean = cleanRange(match[3].trim());

            // Check 1: MATCH Range (Lookup Column)
            if (extractedMatchRangeClean !== cleanRange(expectedMatchRange)) {
                passed = false;
                errorMsg = `The **MATCH range** is incorrect. You should be looking up in the **${task.lookupHeader}** column (${expectedMatchRange}).`;
            }

            // Check 2: INDEX Range (Return Column)
            else if (extractedIndexRangeClean !== cleanRange(expectedIndexRange)) {
                passed = false;
                errorMsg = `The **INDEX range** is incorrect. You must return the value from the **${task.returnHeader}** column (${expectedIndexRange}).`;
            }

            // Check 3: Lookup Value (Syntax and Content)
            if (passed) { // Only proceed if ranges were correct
                if (task.lookupValue === 'MAX' || task.lookupValue === 'MIN') {
                    // FIX: Validate the function used for MIN/MAX lookups
                    const expectedFunc = `${task.lookupValue}(${expectedMatchRange})`;
                    
                    if (cleanValue(extractedLookupValueRaw) !== cleanValue(expectedFunc)) {
                         passed = false;
                         errorMsg = `The lookup value should be a function like **${expectedFunc}** to find the minimum/maximum value in the lookup column.`;
                    }
                } else {
                    // Original checks for literal string/number values
                    
                    // 3a. SYNTAX CHECK: Enforce Quotes for Text Lookup Values
                    if (typeof task.lookupValue === 'string' && !/^\s*("|').*("|')\s*$/.test(extractedLookupValueRaw)) {
                        passed = false;
                        errorMsg = `The lookup value **"${task.lookupValue}"** is text and must be enclosed in double quotes (e.g., "${task.lookupValue}").`;
                    }
                    
                    // 3b. CONTENT CHECK: Check the actual value (only if syntax passed)
                    if (passed && cleanValue(extractedLookupValueRaw) !== cleanValue(task.lookupValue)) {
                        passed = false;
                        errorMsg = `The actual lookup value (**${extractedLookupValueRaw}**) in the MATCH function is incorrect or incorrectly formatted.`;
                    }
                }
            }


            return { passed, errorMsg, expectedAnswer };
        }


        // --- MAIN APPLICATION LOGIC ---

        function loadTask(index) {
            let task;
            let currentStepDisplay = '';

            const formulaInput = document.getElementById('formula-input');
            const formulaLabel = document.getElementById('formula-label');
            const checkButton = document.getElementById('check-button');
            const nextButton = document.getElementById('next-button');
            const challengeButton = document.getElementById('challenge-button');
            const feedbackDiv = document.getElementById('feedback-message');
            const instructions = document.getElementById('mode-instructions');


            if (isChallengeMode) {
                task = challengeTasks[index];
                currentStepDisplay = `(Question ${index + 1} of ${CHALLENGE_LENGTH})`;
                instructions.innerHTML = `**CHALLENGE MODE:** Find the correct formula for 5 random questions. NO FEEDBACK will be given until the end. Submit your formula to mark it and move to the next question.`;
                challengeButton.style.display = 'none';
                
                // CRITICAL FIX: Ensure input elements are visible when challenge mode starts
                formulaInput.style.display = 'block';
                formulaLabel.style.display = 'block';
                checkButton.style.display = 'block';
                nextButton.style.display = 'block'; 

            } else {
                task = tasks[index];
                currentStepDisplay = '';
                instructions.innerHTML = `Enter the full Excel formula to find the correct value based on the dataset below.`;
                challengeButton.style.display = 'block';

                // Ensure input elements are visible in practice mode
                formulaInput.style.display = 'block';
                formulaLabel.style.display = 'block';
                checkButton.style.display = 'block';
                nextButton.style.display = 'block';
            }
            
            if (!task) {
                 // Should only happen in normal mode if all tasks are completed
                document.getElementById('question-display').innerHTML = "🥳 CONGRATULATIONS! You have completed all the practice tasks!";
                document.getElementById('context-display').textContent = "All Tasks Complete";
                document.getElementById('data-table').innerHTML = '';
                formulaInput.style.display = 'none';
                formulaLabel.style.display = 'none';
                checkButton.style.display = 'none';
                nextButton.style.display = 'none';
                feedbackDiv.className = "feedback mt-6 p-4 rounded-lg text-center font-bold text-xl bg-green-100 text-green-700";
                return;
            }

            const dataset = DATA_SETS[task.dataSet];

            // 1. Display Question & Context
            document.getElementById('context-display').textContent = `${task.context} ${currentStepDisplay}`;
            document.getElementById('question-display').textContent = task.question;

            // 2. Clear input and feedback
            formulaInput.value = '';
            feedbackDiv.textContent = '';
            feedbackDiv.className = "feedback mt-6 p-4 rounded-lg text-center font-bold text-xl min-h-[4rem]";
            
            // 3. Reset buttons
            checkButton.disabled = false;
            checkButton.classList.add('check-button-active', 'bg-primary-blue', 'hover:bg-blue-800');
            checkButton.classList.remove('check-button-inactive');

            // Next button is disabled in normal mode until successful check, but needs to be enabled for challenge mode after check
            if (!isChallengeMode) {
                nextButton.disabled = true;
                nextButton.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                nextButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            }


            // 4. Render Data Table with A1 Notation (same as before)
            const table = document.getElementById('data-table');
            table.innerHTML = '';
            const thead = document.createElement('thead');
            const colLetterRow = document.createElement('tr');
            colLetterRow.innerHTML += '<th class="px-3 py-1 text-center text-xs font-bold tracking-wider border-r border-white"></th>';
            dataset.headers.forEach((_, index) => {
                const colLetter = String.fromCharCode('A'.charCodeAt(0) + index);
                colLetterRow.innerHTML += `<th class="px-6 py-1 text-center text-xs font-bold tracking-wider border-r border-white">${colLetter}</th>`;
            });
            thead.appendChild(colLetterRow);
            const dataHeaderRow = document.createElement('tr');
            dataHeaderRow.innerHTML += '<th class="px-3 py-3 text-left text-xs font-bold uppercase tracking-wider text-primary-blue border-r border-gray-200">R#</th>';
            dataset.headers.forEach(header => {
                dataHeaderRow.innerHTML += `<th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-primary-blue">${header}</th>`;
            });
            thead.appendChild(dataHeaderRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';
            dataset.data.forEach((rowData, rowIndex) => {
                const tr = document.createElement('tr');
                tr.className = rowIndex % 2 === 0 ? 'bg-white hover:bg-gray-50' : 'bg-gray-50 hover:bg-gray-100';
                const rowNum = rowIndex + 2; 
                tr.innerHTML += `<td class="px-3 py-4 whitespace-nowrap text-center text-sm font-bold text-gray-600 border-r border-white">${rowNum}</td>`;
                rowData.forEach((cellValue, colIndex) => {
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-800';
                    td.textContent = formatCellValue(cellValue, dataset.headers[colIndex]);
                    const colChar = String.fromCharCode('A'.charCodeAt(0) + colIndex);
                    td.title = `${colChar}${rowNum}`;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
        }

        function resetCheckButton() {
            // Only reset if not in challenge mode (in challenge mode, the next button takes over immediately)
            if (!isChallengeMode && document.getElementById('next-button').disabled) {
                const checkButton = document.getElementById('check-button');
                const feedbackDiv = document.getElementById('feedback-message');
                
                checkButton.disabled = false;
                checkButton.classList.add('check-button-active', 'bg-primary-blue', 'hover:bg-blue-800');
                checkButton.classList.remove('check-button-inactive');
                
                if (feedbackDiv.textContent !== '') {
                    feedbackDiv.textContent = '';
                    feedbackDiv.className = "feedback mt-6 p-4 rounded-lg text-center font-bold text-xl min-h-[4rem]";
                }
            }
        }

        function checkAnswer() {
            const inputFormula = document.getElementById('formula-input').value.trim();
            const feedbackDiv = document.getElementById('feedback-message');
            const checkButton = document.getElementById('check-button');
            const nextButton = document.getElementById('next-button');
            const currentTask = isChallengeMode ? challengeTasks[challengeCurrentStep] : tasks[currentTaskIndex];
            
            if (inputFormula === '') {
                feedbackDiv.textContent = "Please enter a formula before checking.";
                feedbackDiv.classList.add('bg-yellow-100', 'text-yellow-700');
                return;
            }

            // Check formula integrity
            const result = validateFormula(inputFormula, currentTask);
            const { passed, errorMsg, expectedAnswer } = result;

            if (isChallengeMode) {
                
                // --- CHALLENGE MODE LOGIC ---
                
                // 1. Store Result
                challengeResults.push({
                    task: currentTask,
                    formula: inputFormula,
                    passed: passed,
                    errorMsg: errorMsg,
                    expectedAnswer: expectedAnswer,
                    index: challengeCurrentStep + 1
                });
                console.log(`[Challenge ${challengeCurrentStep + 1} Result] Passed: ${passed}. Error: ${errorMsg}`);


                // 2. Track score
                if (passed) {
                    challengeScore++;
                }
                
                // Immediately disable check and enable next button
                checkButton.disabled = true;
                checkButton.classList.remove('check-button-active', 'bg-primary-blue', 'hover:bg-blue-800');
                checkButton.classList.add('check-button-inactive');
                
                nextButton.disabled = false;
                nextButton.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                nextButton.classList.add('bg-green-600', 'hover:bg-green-700');

                // Provide minimal indication
                feedbackDiv.textContent = `Formula submitted for Question ${challengeCurrentStep + 1}. Click Next.`;

            } else {
                // NORMAL MODE: Provide detailed feedback
                if (passed) {
                    const dataset = DATA_SETS[currentTask.dataSet];
                    feedbackDiv.textContent = `✅ Correct! The value is: ${formatCellValue(expectedAnswer, currentTask.returnHeader)}`;
                    feedbackDiv.classList.add('bg-green-100', 'text-green-700');
                    
                    // SUCCESS: Disable check button, enable next button
                    checkButton.disabled = true;
                    checkButton.classList.remove('check-button-active', 'bg-primary-blue', 'hover:bg-blue-800');
                    checkButton.classList.add('check-button-inactive');

                    nextButton.disabled = false;
                    nextButton.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    nextButton.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    // FAILURE: Display specific error message
                    feedbackDiv.textContent = `❌ Incorrect. ${errorMsg}`;
                    feedbackDiv.classList.add('bg-red-100', 'text-red-700');
                }
            }
        }

        function nextTask() {
            if (isChallengeMode) {
                challengeCurrentStep++;
                if (challengeCurrentStep < CHALLENGE_LENGTH) {
                    // Ensure the next button is disabled again for the next question
                    document.getElementById('next-button').disabled = true;
                    document.getElementById('next-button').classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                    document.getElementById('next-button').classList.remove('bg-green-600', 'hover:bg-green-700');
                    loadTask(challengeCurrentStep);
                } else {
                    endChallengeMode();
                }
            } else {
                currentTaskIndex++;
                loadTask(currentTaskIndex);
            }
        }

        function startChallengeMode() {
            // Set state
            isChallengeMode = true;
            challengeScore = 0;
            challengeCurrentStep = 0;
            challengeResults = []; // Reset results for new challenge
            
            // Select and shuffle 5 random tasks
            challengeTasks = ALL_TASKS
                .slice() // Create a shallow copy
                .sort(() => Math.random() - 0.5)
                .slice(0, CHALLENGE_LENGTH);
            
            // Hide normal mode buttons
            document.getElementById('challenge-button').style.display = 'none';

            // CRITICAL FIX: Ensure input elements are displayed
            document.getElementById('formula-input').style.display = 'block';
            document.getElementById('formula-label').style.display = 'block';
            document.getElementById('check-button').style.display = 'block';

            // Load the first challenge task
            loadTask(challengeCurrentStep);
            
            // Ensure next button is available but inactive until submission
            document.getElementById('next-button').disabled = true;
        }

        function endChallengeMode() {
            isChallengeMode = false;
            
            const total = CHALLENGE_LENGTH;
            const score = challengeScore;
            const feedbackDiv = document.getElementById('feedback-message');

            // Clear UI elements and HIDE input elements
            document.getElementById('question-display').innerHTML = `CHALLENGE COMPLETE!`;
            document.getElementById('context-display').textContent = "Challenge Results";
            document.getElementById('data-table').innerHTML = ''; // Clear table
            document.getElementById('formula-input').style.display = 'none';
            document.getElementById('formula-label').style.display = 'none'; // Hiding the label as well
            document.getElementById('check-button').style.display = 'none';
            document.getElementById('next-button').style.display = 'none';
            
            feedbackDiv.innerHTML = ''; // Clear for new content

            // --- SCORE SUMMARY ---
            const scoreSummary = document.createElement('div');
            scoreSummary.className = 'p-6 rounded-lg mb-6 text-center font-bold text-xl';

            if (score === total) {
                scoreSummary.classList.add('bg-green-100', 'text-green-700');
                scoreSummary.innerHTML = `Final Score: <span class="text-2xl font-extrabold">${score} / ${total}</span> 🥳 PERFECT SCORE! You mastered it!`;
            } else if (score >= total * 0.8) {
                scoreSummary.classList.add('bg-yellow-100', 'text-yellow-700');
                scoreSummary.innerHTML = `Final Score: <span class="text-2xl font-extrabold">${score} / ${total}</span> Great job! A little more practice and you'll nail it.`;
            } else {
                scoreSummary.classList.add('bg-red-100', 'text-red-700');
                scoreSummary.innerHTML = `Final Score: <span class="text-2xl font-extrabold">${score} / ${total}</span> Keep practicing! Let's review the mistakes below.`;
            }
            feedbackDiv.appendChild(scoreSummary);

            // --- DETAILED FEEDBACK SECTION (Only for mistakes) ---
            if (score < total) {
                const errorDetails = document.createElement('div');
                errorDetails.className = 'text-left mt-8 p-4 border-t border-gray-200';
                errorDetails.innerHTML = '<h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Detailed Feedback on Mistakes:</h3>';
                
                challengeResults.forEach((result, index) => {
                    if (!result.passed) {
                        const dataSet = DATA_SETS[result.task.dataSet];
                        const item = document.createElement('div');
                        item.className = 'mb-6 p-4 border border-red-200 bg-red-50 rounded-lg shadow-sm';
                        item.innerHTML = `
                            <p class="font-bold text-lg text-red-700 mb-2">Question ${result.index}: ${result.task.question}</p>
                            <p class="text-gray-600 mb-2">Your Formula: <code class="bg-gray-200 p-1 rounded font-mono text-sm">${result.formula || '[No formula submitted]'}</code></p>
                            <p class="font-semibold text-red-800">Error: <span class="font-normal text-red-700">${result.errorMsg}</span></p>
                            <p class="text-green-700 mt-2">Expected Result: <span class="font-bold">${formatCellValue(result.expectedAnswer, result.task.returnHeader)}</span></p>
                            <p class="text-sm text-gray-500 mt-2">Required Lookup Column: **${result.task.lookupHeader}** (${getExpectedRange(result.task.lookupHeader, dataSet.headers, dataSet.data.length)})</p>
                            <p class="text-sm text-gray-500">Required Return Column: **${result.task.returnHeader}** (${getExpectedRange(result.task.returnHeader, dataSet.headers, dataSet.data.length)})</p>
                        `;
                        errorDetails.appendChild(item);
                    }
                });
                
                feedbackDiv.appendChild(errorDetails);
            }
            
            // --- ACTION BUTTONS (Restart/Practice) ---
            const buttonContainer = document.createElement('div');
            buttonContainer.className = "mt-6 pt-4 border-t border-gray-200 flex flex-col sm:flex-row gap-4 justify-center";

            const startNewChallengeBtn = document.createElement('button');
            startNewChallengeBtn.textContent = 'Start New Challenge';
            startNewChallengeBtn.className = 'px-6 py-3 text-lg font-semibold text-white bg-red-600 rounded-lg transition shadow-md hover:bg-red-700';
            startNewChallengeBtn.onclick = startChallengeMode;

            const backToPracticeBtn = document.createElement('button');
            backToPracticeBtn.textContent = 'Back to Practice Mode';
            backToPracticeBtn.className = 'px-6 py-3 text-lg font-semibold text-white bg-primary-blue rounded-lg transition shadow-md hover:bg-blue-800';
            backToPracticeBtn.onclick = () => {
                document.getElementById('formula-input').style.display = 'block';
                document.getElementById('formula-label').style.display = 'block';
                document.getElementById('check-button').style.display = 'block';
                document.getElementById('challenge-button').style.display = 'block';
                document.getElementById('next-button').style.display = 'block'; // Ensure next button is visible for practice mode reset
                currentTaskIndex = 0; 
                loadTask(currentTaskIndex);
            };

            buttonContainer.append(startNewChallengeBtn, backToPracticeBtn);
            feedbackDiv.appendChild(buttonContainer);
        }

        // --- INITIALIZATION ---

        window.onload = function() {
            tasks = ALL_TASKS.slice().sort(() => Math.random() - 0.5);
            loadTask(currentTaskIndex);
            document.getElementById('formula-input').addEventListener('input', resetCheckButton);
        };
    </script>
</body>
</html>
